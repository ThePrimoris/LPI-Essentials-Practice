<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>LPI Exam Practice</title>
  <link rel="stylesheet" href="style.css">
</head>
<body>
  <!-- Start screen -->
  <div id="startScreen" class="start-screen">
    <div class="start-card">
      <h1>LPI Exam Practice</h1>
      <p>Choose quiz length:</p>
      <div class="choices">
        <button id="start40" type="button">40 Questions (random)</button>
        <button id="startAll" type="button">All Questions</button>
      </div>
    </div>
  </div>

  <div class="container">
    <form id="quizForm"></form>

    <div class="nav-buttons">
      <div class="nav-group">
        <button id="prevBtn" type="button">Previous</button>
        <button id="nextBtn" type="button">Next</button>
      </div>
      <div class="submit-group">
        <button id="submitBtn" type="button">Submit</button>
        <button id="restartBtn" class="restart" type="button" title="Choose length again">Restart</button>
      </div>
    </div>
  </div>

  <div id="results"></div>
  <div id="flaggedResults"></div>

  <script>
    const form = document.getElementById('quizForm');
    const results = document.getElementById('results');
    const flaggedResults = document.getElementById('flaggedResults');
    const prevBtn = document.getElementById('prevBtn');
    const nextBtn = document.getElementById('nextBtn');
    const submitBtn = document.getElementById('submitBtn');
    const restartBtn = document.getElementById('restartBtn');

    const startScreen = document.getElementById('startScreen');
    const start40 = document.getElementById('start40');
    const startAll = document.getElementById('startAll');

    let quizData = [];
    let current = 0;

    function shuffle(array) {
      for (let i = array.length - 1; i > 0; i--) {
        const j = Math.floor(Math.random() * (i + 1));
        [array[i], array[j]] = [array[j], array[i]];
      }
      return array;
    }

    // Hide UI until a choice is made
    form.style.display = 'none';
    document.querySelector('.nav-buttons').style.display = 'none';

    function loadQuiz(count /* number | undefined */) {
      fetch('lpi_questions.json')
        .then(response => response.json())
        .then(data => {
          let questions = shuffle(data);
          if (typeof count === 'number' && count > 0 && count < questions.length) {
            questions = questions.slice(0, count);
          }
          quizData = questions.map(q => ({
            ...q,
            options: shuffle([...q.options]),
            flagged: false
          }));

          // Reset UI
          form.innerHTML = '';
          results.textContent = '';
          flaggedResults.innerHTML = '';
          current = 0;

          renderQuestions();
          showQuestion(current);

          form.style.display = '';
          document.querySelector('.nav-buttons').style.display = '';
          startScreen.style.display = 'none';
        })
        .catch(() => {
          alert('Failed to load questions file.');
        });
    }

    start40.addEventListener('click', () => loadQuiz(40));
    startAll.addEventListener('click', () => loadQuiz()); // all

    restartBtn.addEventListener('click', () => {
      // Return to chooser
      form.style.display = 'none';
      document.querySelector('.nav-buttons').style.display = 'none';
      startScreen.style.display = 'flex';
      results.textContent = '';
      flaggedResults.innerHTML = '';
      form.innerHTML = '';
      quizData = [];
      current = 0;
    });

    function renderQuestions() {
      quizData.forEach((q, i) => {
        const div = document.createElement('div');
        div.className = 'question';
        div.id = `q${i}`;

        const flagBtnWrapper = document.createElement('div');
        flagBtnWrapper.className = 'flag-button-wrapper';

        const flagBtn = document.createElement('button');
        flagBtn.className = 'flag-button';
        flagBtn.textContent = 'ðŸš© Flag';
        flagBtn.onclick = function(e) {
          e.preventDefault();
          quizData[i].flagged = !quizData[i].flagged;
          flagBtn.classList.toggle('flagged', quizData[i].flagged);
          flagBtn.textContent = quizData[i].flagged ? 'ðŸš© Flagged' : 'ðŸš© Flag';
        };
        flagBtnWrapper.appendChild(flagBtn);
        div.appendChild(flagBtnWrapper);

        const header = document.createElement('div');
        header.className = 'question-header';

        const title = document.createElement('h2');
        title.innerHTML = `${i + 1}. ${q.question}`;
        header.appendChild(title);
        div.appendChild(header);

        const type = q.answer.length > 1 ? 'checkbox' : 'radio';

        q.options.forEach(opt => {
          const label = document.createElement('label');
          const input = document.createElement('input');
          input.type = type;
          input.name = `q${i}`;
          input.value = opt;
          label.appendChild(input);
          label.append(` ${opt}`);
          div.appendChild(label);
          div.appendChild(document.createElement('br'));
        });

        form.appendChild(div);
      });
    }

    function showQuestion(index) {
      document.querySelectorAll('.question').forEach((el, i) => {
        el.style.display = i === index ? 'block' : 'none';
      });
      prevBtn.style.display = index > 0 ? 'inline-block' : 'none';
      nextBtn.style.display = index < quizData.length - 1 ? 'inline-block' : 'none';
    }

    prevBtn.onclick = () => showQuestion(--current);
    nextBtn.onclick = () => showQuestion(++current);

    submitBtn.onclick = e => {
      e.preventDefault();
      let correct = 0;
      const flaggedList = [];

      quizData.forEach((q, i) => {
        const qDiv = document.getElementById(`q${i}`);
        const header = qDiv.querySelector('.question-header');
        const inputs = qDiv.querySelectorAll(`input[name=q${i}]`);
        const selected = Array.from(inputs).filter(input => input.checked).map(input => input.value);
        const isCorrect = q.answer.length === selected.length && q.answer.every(ans => selected.includes(ans));

        header.classList.remove('correct-answer', 'incorrect-answer');
        header.classList.add(isCorrect ? 'correct-answer' : 'incorrect-answer');
        qDiv.style.display = 'block';
        qDiv.classList.add('submitted');

        inputs.forEach(input => {
          const label = input.parentElement;
          label.classList.remove('correct', 'incorrect', 'selected-answer');

          if (input.checked) {
            label.classList.add('selected-answer');
            if (q.answer.includes(input.value)) {
              label.classList.add('correct');
            } else {
              label.classList.add('incorrect');
            }
          } else if (q.answer.includes(input.value)) {
            label.classList.add('correct');
          }
        });

        if (isCorrect) correct++;
        if (q.flagged) {
          const flagLabel = document.createElement('div');
          flagLabel.className = 'flagged-question-label';
          flagLabel.textContent = 'This question was flagged for review';
          header.appendChild(flagLabel);
          flaggedList.push(`${i + 1}. ${q.question}`);
        }
      });

      results.textContent = `You got ${correct} out of ${quizData.length} correct (${Math.round((correct / quizData.length) * 100)}%)`;

      if (flaggedList.length > 0) {
        flaggedResults.innerHTML =
          `<h3>Flagged Questions for Review:</h3><ul>` +
          flaggedList.map(q => `<li>${q}</li>`).join('') +
          `</ul>`;
      } else {
        flaggedResults.innerHTML = '';
      }
    };
  </script>
</body>
</html>